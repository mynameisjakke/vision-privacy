# Critical Fixes Needed

## Issue 1: Floating Settings Button Not Appearing ❌

### Problem
The floating button JavaScript is generated by the API but **never loaded or executed** by the widget.

### Root Cause
1. API returns `floating_button_js` in widget config ✅
2. Widget fetches config ✅
3. Widget **DOES NOT** inject or execute `floating_button_js` ❌

### Solution
The widget needs to:
1. Extract `floating_button_js` from config
2. Create a `<script>` tag and inject it into the page
3. Execute it after consent is saved

### Code Location
- **File**: `public/vision-privacy-widget.js`
- **Function**: `fetchConfig()` or `init()`
- **Action**: Add code to inject `config.floating_button_js` as a script

### Implementation
```javascript
// After fetching config
if (this.config.floating_button_js) {
  const script = document.createElement('script');
  script.textContent = this.config.floating_button_js;
  document.head.appendChild(script);
}

// Also inject CSS
if (this.config.floating_button_css) {
  const style = document.createElement('style');
  style.textContent = this.config.floating_button_css;
  document.head.appendChild(style);
}
```

---

## Issue 2: Cookies Not Listed in Policy ❌

### Problem
Even though VP consent cookie is detected in scans, it's not showing in policies.

### Root Causes
1. **Timing**: Cookie only detected AFTER consent is given
2. **Scan Selection**: Latest scan might be empty (before consent)
3. **Cache**: Policy might be cached with old data

### Current Status
- ✅ Widget detects VP consent cookie (localStorage)
- ✅ Scan includes it in `detected_cookies`
- ✅ Policy engine uses "best scan" (most cookies)
- ❌ Still not showing in production

### Possible Issues

#### A. Scan Not Being Sent
Check console for POST to `/api/scan` - if missing, scan isn't being sent.

#### B. Scan Being Sent But Empty
The scan runs BEFORE consent, so no VP cookie exists yet.

**Solution**: Always include VP cookie in scan, even if not in localStorage yet:
```javascript
// Always include VP cookie as it WILL be created
cookies.push({
  name: `vp_consent_${this.siteId}`,
  domain: window.location.hostname,
  category: 'essential',
  detected_at: new Date().toISOString(),
  description: 'Stores your cookie consent preferences',
  storage_type: 'localStorage',
  duration: '12 months'
});
```

#### C. Policy Not Fetching Latest Scan
The policy template engine should use the best scan, but might be cached.

**Solution**: Clear cache or force re-fetch.

---

## Quick Fixes to Deploy

### Fix 1: Always Include VP Cookie in Scans
**File**: `public/vision-privacy-widget.js`
**Function**: `scanCookies()`
**Change**: Always add VP cookie, regardless of whether it exists yet

### Fix 2: Inject Floating Button JS
**File**: `public/vision-privacy-widget.js`  
**Function**: `fetchConfig()` or `init()`
**Change**: Inject `floating_button_js` and `floating_button_css` from config

### Fix 3: Trigger Floating Button After Consent
**File**: `public/vision-privacy-widget.js`
**Function**: `saveConsent()`
**Change**: Call `window.VisionPrivacyFloatingButton?.show()` after saving

---

## Testing Checklist

After fixes:
- [ ] Clear browser cache completely
- [ ] Accept cookies on test site
- [ ] Floating button appears in bottom-left
- [ ] Click floating button → settings modal opens
- [ ] Check cookie policy → VP consent cookie listed
- [ ] Decline cookies → floating button still appears
- [ ] Refresh page → floating button persists

---

## Priority
**CRITICAL** - These are core functionality issues that affect all sites.
